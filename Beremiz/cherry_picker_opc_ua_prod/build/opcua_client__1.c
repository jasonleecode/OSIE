/* code generated by beremiz OPC-UA extension */

#include <open62541/client_config_default.h>
#include <open62541/client_highlevel.h>
#include <open62541/plugin/log_stdout.h>

UA_Client *client;

#define DECL_VAR(ua_type, C_type, c_loc_name)                                                       \
UA_Variant *c_loc_name##_variant;                                                                   \
C_type c_loc_name##_buf = 0;                                                                        \
C_type *c_loc_name = &c_loc_name##_buf;


DECL_VAR(UA_Int32, uint32_t, __ID1_0)
DECL_VAR(UA_Int32, uint32_t, __ID1_1)
DECL_VAR(UA_Int32, uint32_t, __ID1_2)
DECL_VAR(UA_Int32, uint32_t, __ID1_3)
DECL_VAR(UA_Int32, uint32_t, __QD1_0)
DECL_VAR(UA_Int32, uint32_t, __QD1_1)
DECL_VAR(UA_Int32, uint32_t, __QD1_2)
DECL_VAR(UA_Int32, uint32_t, __QD1_3)

#define FREE_VARIANT(ua_type, c_loc_name)                                                           \
    UA_Variant_delete(c_loc_name##_variant);

void __cleanup_1(void)
{
    UA_Client_disconnect(client);
    UA_Client_delete(client);

    FREE_VARIANT(UA_Int32, __ID1_0)
    FREE_VARIANT(UA_Int32, __ID1_1)
    FREE_VARIANT(UA_Int32, __ID1_2)
    FREE_VARIANT(UA_Int32, __ID1_3)
    FREE_VARIANT(UA_Int32, __QD1_0)
    FREE_VARIANT(UA_Int32, __QD1_1)
    FREE_VARIANT(UA_Int32, __QD1_2)
    FREE_VARIANT(UA_Int32, __QD1_3)
}


#define ALLOC_VARIANT(ua_type, c_loc_name)                                                          \
    c_loc_name##_variant = UA_Variant_new();

int __init_1(int argc,char **argv)
{
    UA_StatusCode retval;
    client = UA_Client_new();
    UA_ClientConfig_setDefault(UA_Client_getConfig(client));

    ALLOC_VARIANT(UA_Int32, __ID1_0)
    ALLOC_VARIANT(UA_Int32, __ID1_1)
    ALLOC_VARIANT(UA_Int32, __ID1_2)
    ALLOC_VARIANT(UA_Int32, __ID1_3)
    ALLOC_VARIANT(UA_Int32, __QD1_0)
    ALLOC_VARIANT(UA_Int32, __QD1_1)
    ALLOC_VARIANT(UA_Int32, __QD1_2)
    ALLOC_VARIANT(UA_Int32, __QD1_3)

    /* Connect to server */
    retval = UA_Client_connect(client, "opc.tcp://192.168.0.114:4840");
    if(retval != UA_STATUSCODE_GOOD) {
        UA_Client_delete(client);
        return EXIT_FAILURE;
    }
}

#define READ_VALUE(ua_type, ua_type_enum, c_loc_name, ua_nodeid_type, ua_nsidx, ua_node_id)         \
    retval = UA_Client_readValueAttribute(                                                          \
        client, ua_nodeid_type(ua_nsidx, ua_node_id), c_loc_name##_variant);                        \
    if(retval == UA_STATUSCODE_GOOD && UA_Variant_isScalar(c_loc_name##_variant) &&                 \
       c_loc_name##_variant->type == &UA_TYPES[ua_type_enum]) {                                     \
            c_loc_name##_buf = *(ua_type*)c_loc_name##_variant->data;                               \
    }

void __retrieve_1(void)
{
    UA_StatusCode retval;

    READ_VALUE(UA_Int32, UA_TYPES_INT32, __ID1_0, UA_NODEID_STRING, 1, "relay0")
    READ_VALUE(UA_Int32, UA_TYPES_INT32, __ID1_1, UA_NODEID_STRING, 1, "relay1")
    READ_VALUE(UA_Int32, UA_TYPES_INT32, __ID1_2, UA_NODEID_STRING, 1, "relay2")
    READ_VALUE(UA_Int32, UA_TYPES_INT32, __ID1_3, UA_NODEID_STRING, 1, "relay3")
    READ_VALUE(UA_Int32, UA_TYPES_INT32, __QD1_0, UA_NODEID_STRING, 1, "relay0")
    READ_VALUE(UA_Int32, UA_TYPES_INT32, __QD1_1, UA_NODEID_STRING, 1, "relay1")
    READ_VALUE(UA_Int32, UA_TYPES_INT32, __QD1_2, UA_NODEID_STRING, 1, "relay2")
    READ_VALUE(UA_Int32, UA_TYPES_INT32, __QD1_3, UA_NODEID_STRING, 1, "relay3")
}

#define WRITE_VALUE(ua_type, ua_type_enum, c_loc_name, ua_nodeid_type, ua_nsidx, ua_node_id)        \
    UA_Variant_setScalarCopy(c_loc_name##_variant, (ua_type*)c_loc_name, &UA_TYPES[ua_type_enum]);  \
    UA_Client_writeValueAttribute(client, ua_nodeid_type(ua_nsidx, ua_node_id), c_loc_name##_variant);

void __publish_1(void)
{

    WRITE_VALUE(UA_Int32, UA_TYPES_INT32, __ID1_0, UA_NODEID_STRING, 1, "relay0")
    WRITE_VALUE(UA_Int32, UA_TYPES_INT32, __ID1_1, UA_NODEID_STRING, 1, "relay1")
    WRITE_VALUE(UA_Int32, UA_TYPES_INT32, __ID1_2, UA_NODEID_STRING, 1, "relay2")
    WRITE_VALUE(UA_Int32, UA_TYPES_INT32, __ID1_3, UA_NODEID_STRING, 1, "relay3")
    WRITE_VALUE(UA_Int32, UA_TYPES_INT32, __QD1_0, UA_NODEID_STRING, 1, "relay0")
    WRITE_VALUE(UA_Int32, UA_TYPES_INT32, __QD1_1, UA_NODEID_STRING, 1, "relay1")
    WRITE_VALUE(UA_Int32, UA_TYPES_INT32, __QD1_2, UA_NODEID_STRING, 1, "relay2")
    WRITE_VALUE(UA_Int32, UA_TYPES_INT32, __QD1_3, UA_NODEID_STRING, 1, "relay3")
}

